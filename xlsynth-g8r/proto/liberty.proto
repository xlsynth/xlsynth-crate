// SPDX-License-Identifier: Apache-2.0

syntax = "proto3";

package liberty;

// Design policy:
// This schema prefers explicit typed fields for data consumed by algorithms.
// We intentionally avoid a generic key/value "attributes" bag.
// If new Liberty data is needed, add explicit typed fields where consumed.
//
// Validation policy:
// `parse_liberty_files_to_proto()` validates consistency before returning.
// Protos produced by that path are expected to satisfy the invariants noted
// below. If consuming third-party protos, run the same validator before
// relying on those invariants.

message Library {
  // In validated payloads:
  // - cell pin names are unique per cell.
  // - timing arcs reference existing related_pin names.
  // - timing-table/template axes are contiguous (no index_2 without index_1).
  repeated Cell cells = 1;
  LibraryUnits units = 2;
  repeated LuTableTemplate lu_table_templates = 3;
}

message Cell {
  string name = 1;
  repeated Pin pins = 2;
  double area = 3;
  repeated Sequential sequential = 4;
  ClockGate clock_gate = 5;
}

enum PinDirection {
  INVALID = 0;
  OUTPUT = 1;
  INPUT = 2;
}

message Pin {
  PinDirection direction = 1;
  string function = 2;
  string name = 3;
  bool is_clocking_pin = 4;
  optional double capacitance = 5;
  optional double rise_capacitance = 6;
  optional double fall_capacitance = 7;
  optional double max_capacitance = 8;
  repeated TimingArc timing_arcs = 9;
}

message ClockGate {
  string clock_pin = 1;
  string output_pin = 2;
  repeated string enable_pins = 3;
  repeated string test_pins = 4;
}

message LibraryUnits {
  string time_unit = 1;
  string capacitance_unit = 2;
  string voltage_unit = 3;
  string current_unit = 4;
  string resistance_unit = 5;
  string pulling_resistance_unit = 6;
  string leakage_power_unit = 7;
}

message LuTableTemplate {
  // E.g. "lu_table_template", "power_lut_template".
  string kind = 1;
  string name = 2;
  string variable_1 = 3;
  string variable_2 = 4;
  string variable_3 = 5;
  repeated double index_1 = 6;
  repeated double index_2 = 7;
  repeated double index_3 = 8;
}

message TimingArc {
  string related_pin = 1;
  string timing_sense = 2;
  string timing_type = 3;
  string when = 4;
  repeated TimingTable tables = 5;
}

message TimingTable {
  // E.g. "cell_rise", "cell_fall", "rise_transition", "fall_transition".
  string kind = 1;
  // Compact reference into `Library.lu_table_templates`, using 1-based IDs.
  // 0 means "unset".
  // In validated payloads, nonzero IDs are in-range and kind-compatible.
  uint32 template_id = 2;
  // Axes are only populated when this table overrides template axes.
  repeated double index_1 = 3;
  repeated double index_2 = 4;
  repeated double index_3 = 5;
  // Flattened numeric payload in row-major order.
  repeated double values = 6;
  // Shape for `values` payload.
  // In validated payloads:
  // - rank matches effective table axes (explicit index_* or template defaults).
  // - each extent matches the corresponding effective axis length.
  // - `values.len()` equals the product of extents.
  repeated uint32 dimensions = 7;
  // Legacy fallback for compatibility when template_id cannot be resolved.
  string template_name = 8;
}

enum SequentialKind {
  SEQUENTIAL_KIND_UNKNOWN = 0;
  SEQUENTIAL_KIND_FF = 1;
  SEQUENTIAL_KIND_LATCH = 2;
}

// Represents sequential behavior specified via `ff (...) { ... }` or
// `latch (...) { ... }` blocks in Liberty.
message Sequential {
  // The state variable name (e.g. IQ / IQN) referenced by pin functions.
  string state_var = 1;
  // The next-state boolean formula (e.g. scan muxing or fused logic).
  string next_state = 2;
  // The clock/enable expression when present (e.g. clocked_on / enable).
  string clock_expr = 3;
  // The originating Liberty block kind: ff or latch.
  SequentialKind kind = 4;
  // Async clear expression when present on flops.
  string clear_expr = 5;
  // Async preset expression when present on flops.
  string preset_expr = 6;
}
